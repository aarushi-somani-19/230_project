---
title: "Models"
output: pdf_document
date: "2024-04-23"
---

# Need to check assumptions, which maximises adjusted R squared
# Need to add robust SE
# Need to check interactions + need to add other covariates
# Need to try other transformations

```{r}
total_spend_model <- lm(spend_all ~ wave1 + wave2 + wave3, data = aff)
summary(total_spend_model)
plot(total_spend_model)
```

```{r}
total_spend_model_q1 <- lm(spend_all_q1 ~ wave1 + wave2 + wave3, data = aff_clean)
summary(total_spend_model_q1)
plot(total_spend_model_q1)

total_spend_model_q2 <- lm(spend_all_q2 ~ wave1 + wave2 + wave3, data = aff_clean)
summary(total_spend_model_q2)
plot(total_spend_model_q2)

total_spend_model_q3 <- lm(spend_all_q3 ~ wave1 + wave2 + wave3, data = aff_clean)
summary(total_spend_model_q3)
plot(total_spend_model_q3)

total_spend_model_q4 <- lm(spend_all_q4 ~ wave1 + wave2 + wave3, data = aff_clean)
summary(total_spend_model_q4)
plot(total_spend_model_q4)
```

```{r}
aff$statefips <- as.factor(aff$statefips)

# Fit a regression model with statefips as a factor
state_model <- lm(spend_all ~ wave1 + wave2 + wave3 + statefips, data = aff)

# Print the summary of the model
summary(state_model)
plot(state_model)
```

```{r}
# List of spending categories
spending_vars <- c("spend_aap", "spend_acf", "spend_aer", "spend_apg", 
                   "spend_durables", "spend_nondurables", "spend_grf", 
                   "spend_gen", "spend_hic", "spend_hcs", "spend_inperson", 
                   "spend_inpersonmisc", "spend_remoteservices", "spend_sgh", 
                   "spend_tws", "spend_retail_w_grocery", "spend_retail_no_grocery", 
                   "spend_all_incmiddle", "spend_all_q1", "spend_all_q2", 
                   "spend_all_q3", "spend_all_q4")

# Loop through each spending variable and fit a model
for (spend_var in spending_vars) {
  # Fit a linear model for each spending category
  model <- lm(formula = paste(spend_var, "~ wave1 + wave2 + wave3 + statefips"), data = aff)
  
  # Use broom to tidy the model summary
  tidy_model <- tidy(model)
  
  # Print the tidy model summary for each spending category
  cat("\nCoefficient Table for", spend_var, ":\n")
  print(tidy_model)
}
```

# Need to check assumptions, which maximises adjusted R squared
# Need to add robust SE
# Need to check interactions + need to add other covariates
# Need to try other transformations

```{r}
total_emp_model <- lm(emp ~ wave1 + NE + W + S, data = emp)
summary(total_emp_model)
plot(total_emp_model)
```

```{r}
# Calculate VIF values
vif_values <- vif(total_spend_model)
print(vif_values)
```

```{r}
# Calculate VIF values
vif_values <- vif(total_emp_model)
print(vif_values)
```

# Need to check assumptions
# Need to add robust SE
# Need to check interactions + need to add other covariates
# Need to try other transformations
# Need to check which maximises adjusted R squared : accordingly choose best model

```{r}
emp_aff$spend_all <- as.numeric(emp_aff$spend_all)
emp_aff$emp <- as.numeric(emp_aff$emp)

model1 <- lm(spend_all ~ wave1 + emp + NE + W + S, data = emp_aff)
summary(model1)
plot(model1)

model2 <- lm(log(spend_all + 1) ~ wave1 + emp + NE + W + S, data = emp_aff)
summary(model2)
plot(model2)

model3 <- lm(log(spend_all + 1) ~ wave1 + log(emp + 1) + NE + W + S, data = emp_aff)
summary(model3)
plot(model3)
```

```{r}
# Calculate VIF values
vif_values1 <- vif(model1)
print(vif_values1)
vif_values2 <- vif(model2)
print(vif_values2)
vif_values3 <- vif(model3)
print(vif_values3)
```

# Model with emp_aff_math_biz_covid

```{r}
model4 <- lm(revenue_all ~ wave1 + emp + spend_all + engagement + merchants_all + NE + W + S + case_rate, data = emp_aff_math_biz_covid)
robust_se <- vcovHC(model4, type = "HC1")
coeftest(model4, robust_se) #hetero
summary(model4) #homo
plot(model4)
```

# Extra models with full_model1 for justification

## Convert data to type numeric MUST RUN
```{r}
library(dplyr)

columns_to_convert <- c("emp_incmiddle", "emp_incbelowmed", "emp_incabovemed","emp_incq1","emp_incq2","emp_incq3","emp_incq4","engagement_inchigh", "engagement_inclow","engagement_incmiddle","merchants_professional","merchants_health","merchants_food_accommodation","merchants_other_services","merchants_retail")

# Convert selected columns to numeric
emp_aff_math_biz <- emp_aff_math_biz %>%
  mutate(across(.cols = columns_to_convert, .fns = ~as.numeric(as.character(.))))
```

## Model with spend_all quartiles

```{r}
# extend with spending quartiles

model_0 <- lm(revenue_all ~ wave1 + emp + spend_all_q1 + spend_all_q2 + spend_all_q3 + spend_all_q4  + engagement + merchants_all + NE + W + S, data = emp_aff_math_biz)

robust_se <- vcovHC(model_0, type = "HC1")
coeftest(model_0, robust_se) #hetero
summary(model_0) #homo
```

```{r}
vif(model_0)
```

VIF blows up when we use spend_all_q# -> why we use spend_all

#Training and testing set - up

```{r}
library(caret)

# Assuming emp_aff_math_biz is your full dataset
set.seed(123)  # for reproducibility
cleaned_data1 <- na.omit(emp_aff_math_biz[, c("revenue_all", "wave1", "emp", "spend_all", "engagement", "merchants_all", "NE", "W", "S", "emp_incq1", "emp_incq2", "emp_incq3", "emp_incq4", "spend_all_q1", "spend_all_q2", "spend_all_q3", "spend_all_q4", "engagement_inclow", "engagement_incmiddle", "engagement_inchigh", "merchants_professional", "merchants_health", "merchants_food_accommodation", "merchants_other_services", "merchants_retail")])
training_indices <- createDataPartition(cleaned_data1$revenue_all, p = 0.75, list = FALSE)
training_data <- cleaned_data1[training_indices, ]
testing_data <- cleaned_data1[-training_indices, ]
```

#Training and testing

```{r}
model_0 <- lm(revenue_all ~ wave1 + emp + spend_all_q1 + spend_all_q2 + spend_all_q3 + spend_all_q4  + engagement + merchants_all + NE + W + S, data = training_data)

# Predict and evaluate model_0
predictions_0 <- predict(model_0, newdata = testing_data)
rmse_0 <- sqrt(mean((testing_data$revenue_all - predictions_0)^2))
print(paste("RMSE for Model 0:", rmse_0))
```

## Model with different employment

```{r}
# extend with employment quartiles

model_1 <- lm(revenue_all ~ wave1 + emp_incq1 + emp_incq2 + emp_incq3 + emp_incq4 + spend_all + engagement + merchants_all + NE + W + S, data = emp_aff_math_biz)

#emp_incbelowmed + emp_incmiddle + emp_incabovemed
#emp_incq1 + emp_incq2 + emp_incq3 + emp_incq4

robust_se <- vcovHC(model_1, type = "HC1")
coeftest(model_1, robust_se) #hetero
summary(model_1) #homo
```

```{r}
vif(model_1)
```

Again high/decent VIF

#Training and testing

```{r}
model_1 <- lm(revenue_all ~ wave1 + emp_incq1 + emp_incq2 + emp_incq3 + emp_incq4 + spend_all + engagement + merchants_all + NE + W + S, data = training_data)

# Predict and evaluate model_1
predictions_1 <- predict(model_1, newdata = testing_data)
rmse_1 <- sqrt(mean((testing_data$revenue_all - predictions_1)^2))
print(paste("RMSE for Model 1:", rmse_1))
```

## Model without region

```{r}
model_2 <- lm(revenue_all ~ wave1 + emp + spend_all + engagement + merchants_all, data = emp_aff_math_biz)

robust_se <- vcovHC(model_2, type = "HC1")
coeftest(model_2, robust_se) #hetero
summary(model_2) #homo
```

```{r}
vif(model_2)
```

lower R^2 without region component

#Training and testing

```{r}
model_2 <- lm(revenue_all ~ wave1 + emp + spend_all + engagement + merchants_all, data = training_data)

# Predict and evaluate model_1
predictions_2 <- predict(model_2, newdata = testing_data)
rmse_2 <- sqrt(mean((testing_data$revenue_all - predictions_2)^2))
print(paste("RMSE for Model 2:", rmse_2))
```

## Model with different engagement levels - faulty

```{r}
model_3 <- lm(revenue_all ~ wave1 + emp + spend_all + engagement_inclow + engagement_incmiddle + engagement_inchigh + merchants_all + NE + W + S, data = emp_aff_math_biz)

robust_se <- vcovHC(model_3, type = "HC1")
coeftest(model_3, robust_se) #hetero
summary(model_3) #homo
plot(model_3)
```

```{r}
vif(model_3)
```

#Training and testing

```{r}
model_3 <- lm(revenue_all ~ wave1 + emp + spend_all + engagement_inclow + engagement_incmiddle + engagement_inchigh + merchants_all + NE + W + S, data = training_data)

# Predict and evaluate model_1
predictions_3 <- predict(model_3, newdata = testing_data)
rmse_3 <- sqrt(mean((testing_data$revenue_all - predictions_3)^2))
print(paste("RMSE for Model 3:", rmse_3))
```

# Original Model

```{r}
emp_aff_math_biz <- emp_aff_math_biz %>%
  filter(!is.na(revenue_all))
emp_aff_math_biz$revenue_all <- as.numeric(emp_aff_math_biz$revenue_all)
emp_aff_math_biz$merchants_all <- as.numeric(emp_aff_math_biz$merchants_all)
emp_aff_math_biz$spend_all <- as.numeric(emp_aff_math_biz$spend_all)
emp_aff_math_biz$emp <- as.numeric(emp_aff_math_biz$emp)
emp_aff_math_biz$engagement <- as.numeric(emp_aff_math_biz$engagement)

full_model1 <- lm(revenue_all ~ wave1 + emp + spend_all + engagement + merchants_all + NE + W + S, data = emp_aff_math_biz)
robust_se <- vcovHC(full_model1, type = "HC1")
coeftest(full_model1, robust_se) #hetero
summary(full_model1) #homo
plot(full_model1)
```

#Training and testing

```{r}
full_model_1 <- lm(revenue_all ~ wave1 + emp + spend_all + engagement + merchants_all + NE + W + S, data = training_data)

# Predict and evaluate model_1
predictions_f1 <- predict(full_model_1, newdata = testing_data)
rmse_f1 <- sqrt(mean((testing_data$revenue_all - predictions_f1)^2))
print(paste("RMSE for Model 4:", rmse_f1))
```

## FINAL MODEL

```{r}
model_4 <- lm(revenue_all ~ wave1 + emp + spend_all + engagement + merchants_professional + merchants_health + merchants_food_accommodation + merchants_other_services + merchants_retail + NE + W + S, data = emp_aff_math_biz)

robust_se <- vcovHC(model_4, type = "HC1")
coeftest(model_4, robust_se) #hetero
summary(model_4) #homo
#plot(model_4)
```

```{r}
vif(model_4)
```

#Training and testing

```{r}
model_4 <- lm(revenue_all ~ wave1 + emp + spend_all + engagement + merchants_professional + merchants_health + merchants_food_accommodation + merchants_other_services + merchants_retail + NE + W + S, data = training_data)

# Predict and evaluate model_1
predictions_4 <- predict(model_4, newdata = testing_data)
rmse_4 <- sqrt(mean((testing_data$revenue_all - predictions_4)^2))
print(paste("RMSE for Model 4:", rmse_4))
```

# Interactions

Based on EDA we consider different interactions:

## Final model + emp*spend_all

```{r}
# Interactions Model
int_model <- lm(revenue_all ~ wave1 + emp + spend_all + engagement +
                 merchants_professional + merchants_health + 
                 merchants_food_accommodation + merchants_other_services + 
                 merchants_retail + NE + W + S + emp*spend_all, data = emp_aff_math_biz)
                   
summary(int_model)
AIC(model_4, int_model)
BIC(model_4, int_model)
```
## Final model + emp*spend_all + waves*merchants

```{r}
# Update your model to include new interactions
int_model_1 <- update(int_model, . ~ . + wave1:merchants_professional + wave1:merchants_health + wave1:merchants_food_accommodation + wave1:merchants_other_services + wave1:merchants_retail)

# Check summary for significance
summary(int_model_1)
AIC(model_4, int_model_1)
BIC(model_4, int_model_1)
```
adjusted R-squared worse with emp*spend_all interaction

## Final model + emp*spend_all + emp*merchants

```{r}
# Update your model to include new interactions
int_model_2 <- update(int_model, . ~ . + emp:merchants_professional + emp:merchants_health + emp:merchants_food_accommodation + emp:merchants_other_services + emp:merchants_retail)

# Check summary for significance
summary(int_model_2)
AIC(model_4, int_model_2)
BIC(model_4, int_model_2)
```










